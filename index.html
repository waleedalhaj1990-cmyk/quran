<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Quran Tasmi</title>
</head>
<body>
<h2>Smart Quran Tasmi</h2>

<div id="ayahContainer"></div>
<button id="startBtn">Start Tasmi</button>

<script>
const ayat = [
  { text: "In the name of Allah, the Most Gracious, the Most Merciful" },
  { text: "All praise is due to Allah, Lord of the worlds" },
  { text: "The Most Gracious, the Most Merciful" },
  { text: "Master of the Day of Judgment" }
];

const ayahContainer = document.getElementById("ayahContainer");
const startBtn = document.getElementById("startBtn");

let currentIndex = 0;
let recognition;
let readBuffer = "";

// Normalize text for comparison
function normalizeText(text) {
  return text.toLowerCase().replace(/[^\w\s]/gi, '').trim();
}

// Simple similarity calculation
function calculateSimilarity(input, target) {
  const inputWords = input.split(" ");
  const targetWords = target.split(" ");
  let matchCount = 0;
  inputWords.forEach(word => {
    if (targetWords.includes(word)) matchCount++;
  });
  return matchCount / Math.max(inputWords.length, targetWords.length);
}

// Display current Ayah
function displayAyah(index) {
  ayahContainer.textContent = ayat[index].text;
}

// Move to next Ayah
function moveToNextAyah() {
  if (currentIndex < ayat.length - 1) {
    currentIndex++;
    displayAyah(currentIndex);
  } else {
    alert("Tasmi completed!");
    recognition.stop();
  }
}

// Start speech recognition
function startRecognition() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.lang = "en-US";

  recognition.onresult = (event) => {
    const transcript = Array.from(event.results)
      .map(result => result[0].transcript)
      .join(" ");

    readBuffer += " " + transcript;
    readBuffer = readBuffer.trim();

    // Check for all remaining ayat starting from current
    for (let i = currentIndex; i < ayat.length; i++) {
      const similarity = calculateSimilarity(normalizeText(readBuffer), normalizeText(ayat[i].text));
      if (similarity > 0.4) { // Threshold to detect the ayah has been read
        currentIndex = i;
        displayAyah(currentIndex);
        readBuffer = ""; // Clear buffer after recognizing
        moveToNextAyah();
        break;
      }
    }
  };

  recognition.onerror = (event) => {
    console.error("Speech recognition error:", event.error);
  };

  recognition.start();
}

startBtn.addEventListener("click", () => {
  currentIndex = 0;
  displayAyah(currentIndex);
  readBuffer = "";
  startRecognition();
});
</script>
</body>
</html>
